name: Build and Deploy Router

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || github.ref_name }}
  cancel-in-progress: ${{ !(contains(fromJSON('["main","develop"]'), github.ref_name) || (github.event_name == 'pull_request' && contains(fromJSON('["main","develop"]'), github.event.pull_request.base.ref))) }}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/pokenae-web

jobs:
  test:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run tests
        run: npm run test || true

  build-main:
    if: github.event_name == 'push' && github.ref_name == 'main'
    needs: test
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/reusable-build-push.yml
    with:
      image_tag: main
      environment: production
    secrets:
      api_url: ${{ secrets.PROD_API_URL }}
      google_redirect_uri: ${{ secrets.PROD_GOOGLE_REDIRECT_URI }}
      google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}

  build-develop:
    if: github.event_name == 'push' && github.ref_name == 'develop'
    needs: test
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/reusable-build-push.yml
    with:
      image_tag: develop
      environment: development
    secrets:
      api_url: ${{ secrets.DEV_API_URL }}
      google_redirect_uri: ${{ secrets.DEV_GOOGLE_REDIRECT_URI }}
      google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}

  deploy-main-vps:
    if: github.event_name == 'push' && github.ref_name == 'main'
    needs: build-main
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/reusable-deploy-vps.yml
    with:
      compose_file: docker-compose.prod.yml
      project_name: pokenae-prod
      container_name: pokenae-web-prod
      image_tag: main
      port: "3001"
    secrets:
      host: ${{ secrets.HOST }}
      username: ${{ secrets.USERNAME }}
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
      nextauth_url: ${{ secrets.PROD_NEXTAUTH_URL }}
      nextauth_secret: ${{ secrets.NEXTAUTH_SECRET }}
      google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
      google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}

  # =================================================================
  # Azure Container Apps デプロイ（develop ブランチ → ACA 開発環境）
  # reusable-deploy-azure-container-apps.yml はアプリ種類に依存しない
  # 汎用ワークフロー。環境変数は env_vars / secret_env_vars で指定。
  # =================================================================

  deploy-develop-aca:
    if: github.event_name == 'push' && github.ref_name == 'develop'
    needs: build-develop
    permissions:
      contents: read
    uses: ./.github/workflows/reusable-deploy-azure-container-apps.yml
    with:
      container_app_name: pokenae-web-develop
      resource_group: ${{ vars.AZURE_RESOURCE_GROUP }}
      image: ghcr.io/${{ github.repository_owner }}/pokenae-web:develop
      registry_server: ghcr.io
      env_vars: "NODE_ENV=production PORT=3000 NEXTAUTH_URL=${{ vars.DEV_NEXTAUTH_URL_ACA }}"
    secrets:
      azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
      registry_username: ${{ secrets.GHCR_USERNAME }}
      registry_password: ${{ secrets.GHCR_PASSWORD }}
      secret_env_vars: "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }} GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
