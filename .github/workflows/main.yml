name: Build and Deploy Router

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || github.ref_name }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/pokenae-web

jobs:
  test:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run tests
        run: npm run test || true

  build-main:
    if: github.event_name == 'push' && github.ref_name == 'main'
    needs: test
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/reusable-build-push.yml
    with:
      image_tag: main
      environment: production
    secrets:
      api_url: ${{ secrets.PROD_API_URL }}
      google_redirect_uri: ${{ secrets.PROD_GOOGLE_REDIRECT_URI }}
      google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}

  build-develop:
    if: github.event_name == 'push' && github.ref_name == 'develop'
    needs: test
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/reusable-build-push.yml
    with:
      image_tag: develop
      environment: development
    secrets:
      api_url: ${{ secrets.DEV_API_URL }}
      google_redirect_uri: ${{ secrets.DEV_GOOGLE_REDIRECT_URI }}
      google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}

  deploy-main-vps:
    if: github.event_name == 'push' && github.ref_name == 'main'
    needs: build-main
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/reusable-deploy-vps.yml
    with:
      compose_file: docker-compose.prod.yml
      project_name: pokenae-prod
      container_name: pokenae-web-prod
      image_tag: main
      port: "3001"
    secrets:
      host: ${{ secrets.HOST }}
      username: ${{ secrets.USERNAME }}
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
      nextauth_url: ${{ secrets.PROD_NEXTAUTH_URL }}
      nextauth_secret: ${{ secrets.NEXTAUTH_SECRET }}
      google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
      google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}

  deploy-develop-vps:
    if: github.event_name == 'push' && github.ref_name == 'develop'
    needs: build-develop
    permissions:
      contents: read
      packages: read
    # 将来 Azure App Service に切り替える場合は、
    # uses を reusable-deploy-azure-appservice.yml に変更し、
    # app_name / publish profile secret を渡す構成に置き換える。
    uses: ./.github/workflows/reusable-deploy-vps.yml
    with:
      compose_file: docker-compose.dev.yml
      project_name: pokenae-dev
      container_name: pokenae-web-dev
      image_tag: develop
      port: "3002"
    secrets:
      host: ${{ secrets.HOST }}
      username: ${{ secrets.USERNAME }}
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
      nextauth_url: ${{ secrets.DEV_NEXTAUTH_URL }}
      nextauth_secret: ${{ secrets.NEXTAUTH_SECRET }}
      google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
      google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
