name: Build and Deploy to ConoHa VPS (Docker)

on:
  push:
    branches:
      - main
      - develop

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  # 【修正】小文字に変換してハイフンに統一
  IMAGE_NAME: ${{ github.repository_owner }}/pokenae-web

jobs:
  # ==========================================
  # Job 1: テスト・Lint
  # ==========================================
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run tests
        run: npm run test || true

  # ==========================================
  # Job 2: Docker イメージのビルドとプッシュ
  # ==========================================
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.settings.outputs.image_tag }}
      container_name: ${{ steps.settings.outputs.container_name }}
      port: ${{ steps.settings.outputs.port }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Determine deployment settings
        id: settings
        run: |
          set -euo pipefail

          TARGET_BRANCH="${{ github.ref_name }}"

          if [ "$TARGET_BRANCH" = "main" ]; then
            echo "image_tag=main" >> $GITHUB_OUTPUT
            echo "container_name=pokenae-web-prod" >> $GITHUB_OUTPUT
            echo "port=3001" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "api_url=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
            echo "google_redirect_uri=${{ secrets.PROD_GOOGLE_REDIRECT_URI }}" >> $GITHUB_OUTPUT
          elif [ "$TARGET_BRANCH" = "develop" ]; then
            echo "image_tag=develop" >> $GITHUB_OUTPUT
            echo "container_name=pokenae-web-dev" >> $GITHUB_OUTPUT
            echo "port=3002" >> $GITHUB_OUTPUT
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "api_url=${{ secrets.DEV_API_URL }}" >> $GITHUB_OUTPUT
            echo "google_redirect_uri=${{ secrets.DEV_GOOGLE_REDIRECT_URI }}" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] Unsupported target branch: $TARGET_BRANCH"
            exit 1
          fi

          echo "[INFO] Building for branch: $TARGET_BRANCH"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_ENVIRONMENT=${{ steps.settings.outputs.environment }}
            NEXT_PUBLIC_API_URL=${{ steps.settings.outputs.api_url }}
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            NEXT_PUBLIC_GOOGLE_REDIRECT_URI=${{ steps.settings.outputs.google_redirect_uri }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # Job 3: ConoHa VPS へのデプロイ
  # ==========================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment settings
        id: settings
        run: |
          set -euo pipefail

          TARGET_BRANCH="${{ github.ref_name }}"

          if [ "$TARGET_BRANCH" = "main" ]; then
            NEXTAUTH_URL_VALUE="${{ secrets.PROD_NEXTAUTH_URL }}"
            if [ -z "$NEXTAUTH_URL_VALUE" ]; then
              echo "[ERROR] PROD_NEXTAUTH_URL is not set"
              exit 1
            fi
            echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
            echo "project_name=pokenae-prod" >> $GITHUB_OUTPUT
            echo "container_name=pokenae-web-prod" >> $GITHUB_OUTPUT
            echo "image_tag=main" >> $GITHUB_OUTPUT
            echo "port=3001" >> $GITHUB_OUTPUT
            echo "nextauth_url=$NEXTAUTH_URL_VALUE" >> $GITHUB_OUTPUT
          elif [ "$TARGET_BRANCH" = "develop" ]; then
            NEXTAUTH_URL_VALUE="${{ secrets.DEV_NEXTAUTH_URL }}"
            if [ -z "$NEXTAUTH_URL_VALUE" ]; then
              echo "[ERROR] DEV_NEXTAUTH_URL is not set"
              exit 1
            fi
            echo "compose_file=docker-compose.dev.yml" >> $GITHUB_OUTPUT
            echo "project_name=pokenae-dev" >> $GITHUB_OUTPUT
            echo "container_name=pokenae-web-dev" >> $GITHUB_OUTPUT
            echo "image_tag=develop" >> $GITHUB_OUTPUT
            echo "port=3002" >> $GITHUB_OUTPUT
            echo "nextauth_url=$NEXTAUTH_URL_VALUE" >> $GITHUB_OUTPUT
          fi

          echo "[INFO] Deploying branch: $TARGET_BRANCH"

      - name: Create .ssh directory and add known hosts
        env:
          HOST: ${{ secrets.HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 22 $HOST >> ~/.ssh/known_hosts

      - name: Transfer compose files to VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key

          # デプロイ先ディレクトリを作成
          ssh $USERNAME@$HOST -i private_key -p 22 "mkdir -p ~/pokenae-web/secrets ~/pokenae-web/docker"

          # compose ファイルとエントリポイントを転送
          scp -i private_key -P 22 \
            docker-compose.yml \
            ${{ steps.settings.outputs.compose_file }} \
            $USERNAME@$HOST:~/pokenae-web/

          scp -i private_key -P 22 \
            docker/entrypoint.sh \
            $USERNAME@$HOST:~/pokenae-web/docker/

      - name: Create secrets on VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key

          # VPS 上に secrets ファイルを作成（パーミッション 600 で保護）
          ssh $USERNAME@$HOST -i private_key -p 22 \
            "cd ~/pokenae-web && \
             printf '%s' '${{ secrets.NEXTAUTH_SECRET }}' > secrets/nextauth_secret && \
             printf '%s' '${{ secrets.GOOGLE_CLIENT_ID }}' > secrets/google_client_id && \
             printf '%s' '${{ secrets.GOOGLE_CLIENT_SECRET }}' > secrets/google_client_secret && \
             chmod 600 secrets/*"

          echo "[INFO] Secrets created on VPS"

      - name: Deploy to ConoHa VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key

          ssh $USERNAME@$HOST -i private_key -p 22 \
            "IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.settings.outputs.image_tag }} \
             OVERRIDE_COMPOSE_FILE=${{ steps.settings.outputs.compose_file }} \
             PROJECT_NAME=${{ steps.settings.outputs.project_name }} \
             CONTAINER_NAME=${{ steps.settings.outputs.container_name }} \
             NEXTAUTH_URL=${{ steps.settings.outputs.nextauth_url }} \
             GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
             GITHUB_ACTOR=${{ github.actor }} \
             bash -s" <<'EOF'
          set -euo pipefail

          cd ~/pokenae-web

          LOCK_DIR="/tmp/pokenae-deploy-${PROJECT_NAME}.lock"
          for i in $(seq 1 60); do
            if mkdir "${LOCK_DIR}" 2>/dev/null; then
              break
            fi
            echo "[INFO] Waiting for deployment lock... (${i}/60)"
            sleep 2
          done
          if [ ! -d "${LOCK_DIR}" ]; then
            echo "[ERROR] Failed to acquire deployment lock: ${LOCK_DIR}"
            exit 1
          fi
          trap 'rmdir "${LOCK_DIR}" 2>/dev/null || true' EXIT

          echo "======================================"
          echo "[INFO] Starting deployment"
          echo "[INFO] Project: ${PROJECT_NAME}"
          echo "[INFO] Image: ${IMAGE}"
          echo "[INFO] Compose: docker-compose.yml + ${OVERRIDE_COMPOSE_FILE}"
          echo "======================================"

          # GitHub Container Registry にログイン
          echo "[INFO] Logging in to GitHub Container Registry..."
          echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin

          # イメージを pull
          echo "[INFO] Pulling image..."
          docker pull "${IMAGE}"

          # 同じ compose プロジェクトの既存コンテナ・ネットワークを停止・削除
          echo "[INFO] Stopping existing compose project..."
          IMAGE="${IMAGE}" docker compose \
            -p "${PROJECT_NAME}" \
            -f docker-compose.yml \
            -f "${OVERRIDE_COMPOSE_FILE}" \
            down --remove-orphans 2>/dev/null || true

          # 名前衝突を防ぐため、同名コンテナが残っていれば強制削除
          echo "[INFO] Removing stale container if exists..."
          for i in $(seq 1 10); do
            if docker ps -a --format '{{.Names}}' | grep -qx "${CONTAINER_NAME}"; then
              docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true
              sleep 2
              continue
            fi
            break
          done

          if docker ps -a --format '{{.Names}}' | grep -qx "${CONTAINER_NAME}"; then
            echo "[ERROR] Stale container still exists: ${CONTAINER_NAME}"
            exit 1
          fi

          # docker compose で起動（--force-recreate で確実にコンテナを再作成）
          echo "[INFO] Starting container with docker compose..."
          IMAGE="${IMAGE}" \
          NEXTAUTH_URL="${NEXTAUTH_URL}" \
          docker compose \
            -p "${PROJECT_NAME}" \
            -f docker-compose.yml \
            -f "${OVERRIDE_COMPOSE_FILE}" \
            up -d --no-build --force-recreate

          # 古いイメージを削除（ディスク容量節約）
          echo "[INFO] Cleaning up old images..."
          docker image prune -f

          echo "[INFO] Deployment completed!"
          EOF

      - name: Verify deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key

          ssh $USERNAME@$HOST -i private_key -p 22 \
            "CONTAINER_NAME=${{ steps.settings.outputs.container_name }} \
             PORT=${{ steps.settings.outputs.port }} \
             bash -s" <<'EOF'
          set -euo pipefail

          echo "[INFO] Verifying deployment..."

          for i in $(seq 1 24); do
            CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")
            HEALTH_STATUS=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' "${CONTAINER_NAME}" 2>/dev/null || echo "none")

            if [ "$CONTAINER_STATUS" = "running" ] && [ "$HEALTH_STATUS" != "unhealthy" ]; then
              if curl -sf "http://localhost:${PORT}/" > /dev/null 2>&1; then
                echo "[SUCCESS] Application is responding on port ${PORT}"
                echo "======================================"
                echo "[INFO] Deployment verification completed!"
                echo "[INFO] Container: ${CONTAINER_NAME}"
                echo "[INFO] Status: ${CONTAINER_STATUS}"
                echo "[INFO] Health: ${HEALTH_STATUS}"
                echo "[INFO] Port: ${PORT}"
                echo "======================================"
                exit 0
              fi
            fi

            echo "[INFO] Waiting for stable startup... (${i}/24) status=${CONTAINER_STATUS}, health=${HEALTH_STATUS}"
            sleep 5
          done

          echo "[ERROR] Deployment verification timed out"
          docker ps -a --filter "name=${CONTAINER_NAME}" || true
          docker logs "${CONTAINER_NAME}" --tail 100 2>/dev/null || true
          exit 1
          EOF
