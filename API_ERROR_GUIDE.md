# API エラー診断・対応ガイド

## 概要

pokenae.Web アプリケーションで API エラーが発生した場合の診断と対応方法を説明します。

## 一般的な API エラーのパターン

### 1. CORS (Cross-Origin Resource Sharing) エラー

**症状:**

- ブラウザのコンソールに "CORS policy" に関するエラーメッセージ
- ネットワークタブでリクエストが "blocked" または "failed" と表示

**原因:**

- API サーバー側で CORS の設定が不適切
- フロントエンド（localhost:3000）から API サーバー（localhost:7077）への異なるオリジン間通信が拒否される

**対応方法:**

1. API サーバー側で CORS 設定を追加

```csharp
// ASP.NET Core の場合
app.UseCors(policy => policy
    .AllowAnyOrigin()
    .AllowAnyMethod()
    .AllowAnyHeader());
```

2. 開発環境では `AllowAnyOrigin()` を使用し、本番環境では特定のオリジンのみ許可

### 2. SSL 証明書エラー

**症状:**

- "certificate" または "SSL" に関するエラーメッセージ
- HTTPS への接続が失敗する

**原因:**

- 開発環境で自己署名証明書を使用している
- ブラウザが証明書を信頼していない

**対応方法:**

1. 開発環境で HTTP を使用する（推奨）

```javascript
// .env.local
NEXT_PUBLIC_API_BASE_URL=http://localhost:7077
```

2. または、ブラウザで自己署名証明書を信頼する
   - https://localhost:7077 に直接アクセス
   - "詳細設定" → "安全ではないサイトに進む"

### 3. API サーバー未起動エラー

**症状:**

- "Failed to fetch" エラー
- "Connection refused" または "ERR_CONNECTION_REFUSED"

**原因:**

- API サーバーが起動していない
- ポート 7077 でサービスが動作していない

**対応方法:**

1. API サーバーの起動を確認

```powershell
netstat -an | findstr 7077
```

2. API サーバーが起動していない場合は起動する

### 4. API エンドポイント不在エラー

**症状:**

- HTTP 404 Not Found エラー
- 特定のエンドポイントのみエラー

**原因:**

- API サーバー側でエンドポイントが実装されていない
- ルーティング設定の問題

**対応方法:**

1. API サーバーのルーティング設定を確認
2. エンドポイントの実装状況を確認

## 現在のフォールバック機能

### 自動フォールバック

API エラーが発生した場合、アプリケーションは自動的にデモデータにフォールバックします：

1. **コレクション一覧**: デモコレクション（ポケモンカード、フィギュア、本・漫画）を表示
2. **コレクション詳細**: 各コレクションのサンプルアイテムを表示
3. **カラム情報**: コレクションタイプに応じたデフォルトカラムを使用

### デモモード表示

- API に接続できない場合、画面上部に「デモモード」と表示
- ユーザーに API サーバーの状況を明確に通知

## 診断ツール

### API テストページ

開発用の API テストページを利用して詳細な診断を実行できます：

- アクセス: http://localhost:3000/api-test
- 各 API エンドポイントの接続テスト
- 詳細なエラー情報の表示
- 環境情報の確認

### ブラウザ開発者ツール

1. **Network タブ**: HTTP リクエスト/レスポンスの詳細を確認
2. **Console タブ**: JavaScript エラーと API レスポンスログを確認
3. **Application タブ**: 環境変数と設定値を確認

## トラブルシューティング手順

### Step 1: 基本的な接続確認

1. API サーバーが起動しているか確認

```powershell
netstat -an | findstr 7077
```

2. ブラウザで直接 API にアクセス

```
https://localhost:7077/api/collections
```

### Step 2: 環境設定の確認

1. `.env.local` ファイルの設定確認

```bash
NEXT_PUBLIC_API_BASE_URL=https://localhost:7077
```

2. Next.js アプリケーションの再起動

```bash
npm run dev
```

### Step 3: API サーバー設定の確認

1. CORS 設定の確認
2. SSL 証明書の設定確認
3. ログの確認

### Step 4: 詳細診断

1. API テストページでの診断実行
2. ブラウザ開発者ツールでの詳細確認
3. ネットワークタブでのリクエスト/レスポンス確認

## 実際の API エンドポイントテスト手順

### 手動テスト

以下のエンドポイントに直接アクセスして API の動作を確認できます：

1. **コレクションテーブル一覧取得**:

   ```
   https://localhost:7077/api/CollectionTable
   ```

2. **特定のコレクションテーブル詳細** (例: tableId = f1dbf3a5-3b86-4939-99e8-d564a11b4326):

   ```
   https://localhost:7077/api/CollectionTable/f1dbf3a5-3b86-4939-99e8-d564a11b4326
   ```

3. **特定テーブルのレコード一覧**:
   ```
   https://localhost:7077/api/Record/table/f1dbf3a5-3b86-4939-99e8-d564a11b4326
   ```

### API テストページでの自動テスト

アプリケーション内のテストページを使用：

- URL: `http://localhost:3000/api-test`
- 実際のエンドポイントを含む包括的なテストを自動実行
- エラー内容と詳細レスポンス情報を確認可能

## 設定ファイルの場所

- **環境変数**: `.env.local`, `.env.example`
- **API クライアント**: `src/utils/collectionApi.js`
- **フォールバック機能**: `src/utils/demoData.js`
- **診断ツール**: `src/app/api-test/page.js`

## よくある問題と解決方法

### 問題: "Failed to fetch" エラー

**解決方法:**

1. API サーバーの起動確認
2. ファイアウォール設定の確認
3. ウイルス対策ソフトの除外設定

### 問題: HTTPS 接続エラー

**解決方法:**

1. HTTP での接続に変更
2. 自己署名証明書の信頼設定
3. 開発用証明書の再生成

### 問題: データが正しく表示されない

**解決方法:**

1. API レスポンス形式の確認
2. データ変換処理の確認
3. デモデータとの比較

## サポート情報

開発中に API エラーが解決できない場合は、以下の情報を収集してください：

1. ブラウザコンソールのエラーメッセージ
2. ネットワークタブのリクエスト/レスポンス詳細
3. API サーバーのログ
4. 環境設定ファイルの内容
5. API テストページの診断結果

これらの情報をもとに、具体的な対応方法を提案できますにゃん。
