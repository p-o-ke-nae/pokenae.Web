# ベース共通設定（ローカル・CI/CD 共通）
# 使い方（-p でプロジェクト名を分けることで複数環境を同時起動可能）:
#   デバッグ環境: docker compose -p pokenae-debug -f docker-compose.yml -f docker-compose.debug.yml up --build
#   開発環境:     docker compose -p pokenae-dev   -f docker-compose.yml -f docker-compose.dev.yml up -d --build
#   本番環境:     docker compose -p pokenae-prod  -f docker-compose.yml -f docker-compose.prod.yml up -d --build
# CI/CD では IMAGE 環境変数で GHCR のイメージを指定し、--no-build で起動する
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api.example.com}
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
        NEXT_PUBLIC_GOOGLE_REDIRECT_URI: ${NEXT_PUBLIC_GOOGLE_REDIRECT_URI}
    # PID 1 問題の解決: tini を init プロセスとして使用し、ゾンビプロセスを自動回収する
    init: true
    # 認証に必要なシークレットをコンテナに注入（/run/secrets/ にマウントされる）
    # entrypoint.sh がファイルを読み取り環境変数に展開する
    secrets:
      - nextauth_secret
      - google_client_id
      - google_client_secret

# シークレット定義（secrets/ ディレクトリ内のファイルから読み取り）
# secrets/ ディレクトリは .gitignore で除外されている
secrets:
  nextauth_secret:
    file: ./secrets/nextauth_secret
  google_client_id:
    file: ./secrets/google_client_id
  google_client_secret:
    file: ./secrets/google_client_secret
